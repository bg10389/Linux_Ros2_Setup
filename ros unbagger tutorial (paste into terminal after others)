# --- paste this whole block ---
set -euo pipefail

echo "==[A] Install ROS 2 Kilted (if missing) + deps for ros2-unbag =="
. /etc/os-release
echo "Detected: ${PRETTY_NAME:-unknown}"

# Base tooling + locale
sudo apt update
sudo apt install -y locales software-properties-common curl ca-certificates gnupg lsb-release
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
export LANG=en_US.UTF-8

# Universe
sudo add-apt-repository -y universe

# Add ROS 2 apt source (official ros2-apt-source package)
sudo apt update
ROS_APT_SOURCE_VERSION="$(
  curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest \
  | grep -F "tag_name" | awk -F\" '{print $4}'
)"
CODENAME="$(
  . /etc/os-release
  echo "${UBUNTU_CODENAME:-${VERSION_CODENAME}}"
)"
curl -L -o /tmp/ros2-apt-source.deb \
  "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.${CODENAME}_all.deb"
sudo dpkg -i /tmp/ros2-apt-source.deb

# Install ROS 2 Kilted if not present
sudo apt update
if [[ -d /opt/ros/kilted ]]; then
  echo "ROS 2 Kilted already present at /opt/ros/kilted"
else
  sudo apt install -y ros-kilted-desktop
fi

# GUI runtime deps + venv tooling (per ros2_unbag docs)
sudo apt install -y \
  libxcb-cursor0 libxcb-shape0 libxcb-icccm4 libxcb-keysyms1 libxkbcommon-x11-0 \
  python3-venv python3-pip python3-dev build-essential git

echo "==[B] Create dedicated venv + install ros2-unbag into it =="
VENV_DIR="$HOME/.venvs/ros2-unbag"
if [[ ! -d "$VENV_DIR" ]]; then
  python3 -m venv "$VENV_DIR"
fi

# Source ROS then venv, then install
source /opt/ros/kilted/setup.bash
source "$VENV_DIR/bin/activate"

python -m pip install -U pip setuptools wheel
python -m pip install -U ros2-unbag

# Make ros2 inside venv run through venv python so plugins (if any) are visible
cat > "$VENV_DIR/bin/ros2" <<'EOF'
#!/usr/bin/env bash
exec python -m ros2cli "$@"
EOF
chmod +x "$VENV_DIR/bin/ros2"

echo "==[C] Create global 'unbag' command (works from anywhere) =="
mkdir -p "$HOME/.local/bin"
cat > "$HOME/.local/bin/unbag" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

source /opt/ros/kilted/setup.bash
source "$HOME/.venvs/ros2-unbag/bin/activate"

# Prefer plugin form if it exists; fallback to standalone entrypoint
if ros2 --help 2>/dev/null | grep -qi unbag; then
  exec ros2 unbag "$@"
fi
exec ros2-unbag "$@"
EOF
chmod +x "$HOME/.local/bin/unbag"

# Ensure ~/.local/bin is on PATH for future shells
if ! grep -qs 'export PATH="\$HOME/.local/bin:\$PATH"' "$HOME/.bashrc"; then
  echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
fi

hash -r || true

echo
echo "DONE."
echo "Run this now:"
echo "  unbag"
echo
echo "If a new terminal doesn't find it yet, run:"
echo '  export PATH="$HOME/.local/bin:$PATH"'
